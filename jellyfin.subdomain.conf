## Jellyfin Reverse Proxy Configuration â€“ Hardened & Optimized
# Clean rebuild (previous file had corrupted structure). Place in http context.

## Rate limiting zones
limit_req_zone $binary_remote_addr zone=jellyfin_general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=jellyfin_api:10m rate=25r/s;
limit_req_zone $binary_remote_addr zone=jellyfin_auth:10m rate=20r/m;

## Connection limiting
limit_conn_zone $binary_remote_addr zone=jellyfin_conn:10m;

## WebSocket upgrade mapping
map $http_upgrade $connection_upgrade {
  default upgrade; '' close;
}

## Proxy cache (comment out if unwanted)
proxy_cache_path /var/cache/nginx/jellyfin levels=1:2 keys_zone=jellyfin_cache:100m max_size=5g inactive=24h use_temp_path=off;

## Logging formats
log_format jellyfin_main '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent ' '"$http_referer" "$http_user_agent" rt=$request_time uct=$upstream_connect_time urt=$upstream_response_time cache=$upstream_cache_status';
log_format jellyfin_minimal '$remote_addr [$time_local] "$request" $status $body_bytes_sent cache=$upstream_cache_status rt=$request_time';

upstream jellyfin_backend {
  server 172.18.0.1:8096 max_fails=3 fail_timeout=30s;
  keepalive 32;
  keepalive_requests 1000;
  keepalive_timeout 60s;
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name jellyfin.*;
  include /config/nginx/ssl.conf;

  client_max_body_size 4G;
  client_body_buffer_size 256k;
  client_header_buffer_size 4k;
  large_client_header_buffers 8 16k;
  client_body_timeout 60s;
  client_header_timeout 60s;
  limit_conn jellyfin_conn 50;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header X-Robots-Tag "noindex, nofollow" always;
  add_header Cross-Origin-Opener-Policy "same-origin" always;
  add_header Cross-Origin-Embedder-Policy "require-corp" always;
  add_header Cross-Origin-Resource-Policy "same-site" always;
  add_header Content-Security-Policy "default-src 'self' data: blob:; script-src 'self' 'unsafe-inline' blob: data:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; media-src 'self' blob: https: data:; connect-src 'self' wss: https:; font-src 'self' data: https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

  proxy_hide_header X-Powered-By;
  proxy_hide_header Server;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port $server_port;
  proxy_set_header X-Forwarded-Ssl on;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_buffering on;
  proxy_temp_path /tmp/nginx-proxy-temp;
  proxy_cache_lock on;
  proxy_cache_revalidate on;
  proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 updating;
  proxy_cache_background_update on;

  proxy_connect_timeout 30s;
  proxy_send_timeout 300s;
  proxy_read_timeout 300s;
  proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
  proxy_next_upstream_tries 3;
  proxy_next_upstream_timeout 10s;
  keepalive_timeout 65;
  keepalive_requests 1000;
  send_timeout 60s;

  gzip on;
  gzip_vary on;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types application/atom+xml application/geo+json application/javascript application/x-javascript application/json application/ld+json application/manifest+json application/rdf+xml application/rss+xml application/xhtml+xml application/xml font/eot font/otf font/ttf image/svg+xml text/css text/javascript text/plain text/xml;

  access_log /var/log/nginx/jellyfin_access.log jellyfin_main;
  error_log /var/log/nginx/jellyfin_error.log warn;

  # Static assets
  location ~* \.(css|js)$ {
    proxy_pass http://jellyfin_backend;
    expires 1y;
    add_header Cache-Control "public, immutable";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 301 302 365d;
  }
  location ~* \.(woff2|woff|ttf|eot|otf)$ {
    proxy_pass http://jellyfin_backend;
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 365d;
  }
  location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
    proxy_pass http://jellyfin_backend;
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept, Accept-Encoding";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 301 302 30d;
  }
  location ~* \.(webmanifest|manifest\.json)$ {
    proxy_pass http://jellyfin_backend;
    expires 1d;
    add_header Cache-Control "public, must-revalidate";
  }

  # WebSockets
  location ~* ^/(socket|hubs|signalr) {
    proxy_pass http://jellyfin_backend;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 7200s;
    proxy_send_timeout 7200s;
    proxy_connect_timeout 10s;
    proxy_buffering off;
    proxy_socket_keepalive on;
    access_log /var/log/nginx/jellyfin_websocket.log jellyfin_minimal;
  }

  # Auth
  location ~* ^/(Users/authenticatebyname|Users/authenticatewithquickconnect) {
    limit_req zone=jellyfin_auth burst=5 nodelay;
    proxy_pass http://jellyfin_backend;
    expires off;
    add_header Cache-Control "no-cache, no-store, must-revalidate, private";
    add_header Pragma "no-cache";
  }

  # Video streaming
  location ~* ^/Videos/.*/stream {
    proxy_pass http://jellyfin_backend;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_force_ranges on;
    tcp_nodelay on;
    tcp_nopush on;
    sendfile on;
    proxy_connect_timeout 30s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    limit_rate_after 10m;
    add_header Accept-Ranges bytes always;
    add_header X-Content-Type-Options nosniff always;
    access_log /var/log/nginx/jellyfin_stream_access.log jellyfin_minimal;
  }

  # Playlists
  location ~* ^/Videos/.*\.(m3u8|mpd)$ {
    proxy_pass http://jellyfin_backend;
    expires 10s;
    add_header Cache-Control "public, max-age=10";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 10s;
    access_log /var/log/nginx/jellyfin_playlists.log jellyfin_minimal;
  }

  # Segments
  location ~* ^/Videos/.*\.(ts|m4s)$ {
    proxy_pass http://jellyfin_backend;
    expires 6h;
    add_header Cache-Control "public, max-age=21600, immutable";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 206 6h;
    tcp_nodelay on;
    sendfile on;
    access_log off;
  }

  # Audio
  location ~* ^/Audio/.*/stream {
    proxy_pass http://jellyfin_backend;
    proxy_buffering on;
    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_force_ranges on;
    tcp_nodelay on;
    sendfile on;
    proxy_connect_timeout 15s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    add_header Accept-Ranges bytes always;
    access_log /var/log/nginx/jellyfin_audio.log jellyfin_minimal;
  }

  # Item images
  location ~* ^/Items/.*/Images {
    proxy_pass http://jellyfin_backend;
    expires 30d;
    add_header Cache-Control "public, immutable, stale-if-error=604800";
    add_header Vary "Accept, Accept-Encoding, Accept-Language";
    proxy_cache jellyfin_cache;
    proxy_cache_valid 200 30d;
  }

  # Sessions / Transcoding progress
  location ~* ^/(Sessions|Transcoding) {
    limit_req zone=jellyfin_api burst=20 nodelay;
    proxy_pass http://jellyfin_backend;
    expires off;
    add_header Cache-Control "no-cache, no-store, must-revalidate, private";
    proxy_buffering off;
    proxy_connect_timeout 5s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    access_log /var/log/nginx/jellyfin_session.log jellyfin_minimal;
  }

  # Dynamic API (metadata)
  location ~* ^/(Users|Items|Library|Search|Playlists|Collections) {
    limit_req zone=jellyfin_api burst=40 nodelay;
    proxy_pass http://jellyfin_backend;
    expires off;
    add_header Cache-Control "no-cache, no-store, must-revalidate, private";
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Health
  location ~* ^/(System|health) {
    limit_req zone=jellyfin_api burst=10 nodelay;
    proxy_pass http://jellyfin_backend;
    expires 5s;
    add_header Cache-Control "no-cache";
    proxy_buffering off;
    proxy_connect_timeout 2s;
    proxy_send_timeout 5s;
    proxy_read_timeout 5s;
    access_log /var/log/nginx/jellyfin_health.log jellyfin_minimal;
  }

  # Root / UI
  location / {
    limit_req zone=jellyfin_general burst=20 nodelay;
    proxy_pass http://jellyfin_backend;
    expires 5m;
    add_header Cache-Control "public, max-age=300";
    proxy_connect_timeout 15s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
  }

  # Status
  location = /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
  }
}
